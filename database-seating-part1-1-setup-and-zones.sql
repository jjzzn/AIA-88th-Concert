-- AIA 88th Concert - Complete Seating Layout
-- Generated from concert_seating_final_verified.json
-- Run this script in Supabase SQL Editor

-- Enable UUID extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Drop the view that depends on seats.row column
DROP VIEW IF EXISTS seat_swap_history_detailed CASCADE;

-- Clear existing data FIRST (in correct order to respect foreign key constraints)
-- This must be done before altering columns to avoid data length constraint issues
DO $$ 
BEGIN
    -- Delete from seat_locks if table exists
    IF EXISTS (SELECT FROM information_schema.tables WHERE table_name = 'seat_locks') THEN
        DELETE FROM seat_locks;
    END IF;
END $$;

DELETE FROM seat_swap_history;
DELETE FROM booking_seats;
DELETE FROM bookings;

-- Use TRUNCATE for more thorough cleanup
TRUNCATE TABLE seats CASCADE;
TRUNCATE TABLE zones CASCADE;

-- Drop and recreate the row column to avoid type constraint issues
ALTER TABLE seats DROP COLUMN IF EXISTS row;
ALTER TABLE seats ADD COLUMN row VARCHAR(10);

-- Add level column to zones if not exists
ALTER TABLE zones ADD COLUMN IF NOT EXISTS level INTEGER DEFAULT 1;

-- Insert Zones
INSERT INTO zones (id, name, tier_id, capacity, level) VALUES
    ('z1654900-0000-0000-0000-000000000000', 'A1', '11111111-1111-1111-1111-111111111111', 264, 1),
    ('z1655000-0000-0000-0000-000000000000', 'A2', '11111111-1111-1111-1111-111111111111', 400, 1),
    ('z1655100-0000-0000-0000-000000000000', 'A3', '11111111-1111-1111-1111-111111111111', 400, 1),
    ('z1655200-0000-0000-0000-000000000000', 'A4', '11111111-1111-1111-1111-111111111111', 264, 1),
    ('z1664900-0000-0000-0000-000000000000', 'B1', '11111111-1111-1111-1111-111111111111', 244, 1),
    ('z1665000-0000-0000-0000-000000000000', 'B2', '11111111-1111-1111-1111-111111111111', 492, 1),
    ('z1665100-0000-0000-0000-000000000000', 'B3', '11111111-1111-1111-1111-111111111111', 492, 1),
    ('z1665200-0000-0000-0000-000000000000', 'B4', '11111111-1111-1111-1111-111111111111', 244, 1),
    ('z1707000-0000-0000-0000-000000000000', 'FF', '11111111-1111-1111-1111-111111111111', 91, 1),
    ('z1727200-0000-0000-0000-000000000000', 'HH', '11111111-1111-1111-1111-111111111111', 91, 1),
    ('z1867600-0000-0000-0000-000000000000', 'VL', '11111111-1111-1111-1111-111111111111', 37, 1),
    ('z1868200-0000-0000-0000-000000000000', 'VR', '11111111-1111-1111-1111-111111111111', 37, 1),
    ('z2836600-0000-0000-0000-000000000000', 'SB', '22222222-2222-2222-2222-222222222222', 160, 2),
    ('z2836700-0000-0000-0000-000000000000', 'SC', '22222222-2222-2222-2222-222222222222', 160, 2),
    ('z2836800-0000-0000-0000-000000000000', 'SD', '22222222-2222-2222-2222-222222222222', 160, 2),
    ('z2836900-0000-0000-0000-000000000000', 'SE', '22222222-2222-2222-2222-222222222222', 191, 2),
    ('z2837000-0000-0000-0000-000000000000', 'SF', '22222222-2222-2222-2222-222222222222', 160, 2),
    ('z2837100-0000-0000-0000-000000000000', 'SG', '22222222-2222-2222-2222-222222222222', 136, 2),
    ('z2837200-0000-0000-0000-000000000000', 'SH', '22222222-2222-2222-2222-222222222222', 152, 2),
    ('z2837300-0000-0000-0000-000000000000', 'SI', '22222222-2222-2222-2222-222222222222', 136, 2),
    ('z2837400-0000-0000-0000-000000000000', 'SJ', '22222222-2222-2222-2222-222222222222', 160, 2),
    ('z2837500-0000-0000-0000-000000000000', 'SK', '22222222-2222-2222-2222-222222222222', 191, 2),
    ('z2837600-0000-0000-0000-000000000000', 'SL', '22222222-2222-2222-2222-222222222222', 160, 2),
    ('z2837700-0000-0000-0000-000000000000', 'SM', '22222222-2222-2222-2222-222222222222', 160, 2),
    ('z2837800-0000-0000-0000-000000000000', 'SN', '22222222-2222-2222-2222-222222222222', 160, 2),
    ('z3660000-0000-0000-0000-000000000000', 'B', '66666666-6666-6666-6666-666666666666', 297, 3),
    ('z3670000-0000-0000-0000-000000000000', 'C', '66666666-6666-6666-6666-666666666666', 297, 3),
    ('z3680000-0000-0000-0000-000000000000', 'D', '66666666-6666-6666-6666-666666666666', 297, 3),
    ('z3690000-0000-0000-0000-000000000000', 'E', '66666666-6666-6666-6666-666666666666', 306, 3),
    ('z3700000-0000-0000-0000-000000000000', 'F', '66666666-6666-6666-6666-666666666666', 258, 3),
    ('z3710000-0000-0000-0000-000000000000', 'G', '66666666-6666-6666-6666-666666666666', 256, 3),
    ('z3720000-0000-0000-0000-000000000000', 'H', '66666666-6666-6666-6666-666666666666', 276, 3),
    ('z3730000-0000-0000-0000-000000000000', 'I', '66666666-6666-6666-6666-666666666666', 276, 3),
    ('z3740000-0000-0000-0000-000000000000', 'J', '66666666-6666-6666-6666-666666666666', 264, 3),
    ('z3750000-0000-0000-0000-000000000000', 'K', '66666666-6666-6666-6666-666666666666', 198, 3),
    ('z3760000-0000-0000-0000-000000000000', 'L', '66666666-6666-6666-6666-666666666666', 264, 3),
    ('z3770000-0000-0000-0000-000000000000', 'M', '66666666-6666-6666-6666-666666666666', 276, 3),
    ('z3780000-0000-0000-0000-000000000000', 'N', '66666666-6666-6666-6666-666666666666', 276, 3),
    ('z3790000-0000-0000-0000-000000000000', 'O', '66666666-6666-6666-6666-666666666666', 256, 3),
    ('z3800000-0000-0000-0000-000000000000', 'P', '66666666-6666-6666-6666-666666666666', 258, 3),
    ('z3810000-0000-0000-0000-000000000000', 'Q', '66666666-6666-6666-6666-666666666666', 306, 3),
    ('z3820000-0000-0000-0000-000000000000', 'R', '66666666-6666-6666-6666-666666666666', 297, 3),
    ('z3830000-0000-0000-0000-000000000000', 'S', '66666666-6666-6666-6666-666666666666', 297, 3),
    ('z3840000-0000-0000-0000-000000000000', 'T', '66666666-6666-6666-6666-666666666666', 297, 3);

-- Recreate the view after schema changes
CREATE OR REPLACE VIEW seat_swap_history_detailed AS
SELECT 
    ssh.id,
    ssh.booking_seat_id,
    ssh.booking_id,
    ssh.old_seat_id,
    ssh.new_seat_id,
    ssh.swapped_by,
    ssh.swapped_at,
    ssh.reason,
    ssh.admin_notes,
    ssh.admin_ip,
    ssh.status,
    ssh.error_message,
    b.email as booking_email,
    b.phone as booking_phone,
    bs.first_name || ' ' || bs.last_name as attendee_name,
    bs.qr_token,
    os.row as old_row,
    os.number as old_number,
    oz.name as old_zone,
    ot.name as old_tier,
    ns.row as new_row,
    ns.number as new_number,
    nz.name as new_zone,
    nt.name as new_tier,
    b.booking_number
FROM seat_swap_history ssh
LEFT JOIN booking_seats bs ON ssh.booking_seat_id = bs.id
LEFT JOIN bookings b ON ssh.booking_id = b.id
LEFT JOIN seats os ON ssh.old_seat_id = os.id
LEFT JOIN zones oz ON os.zone_id = oz.id
LEFT JOIN tiers ot ON os.tier_id = ot.id
LEFT JOIN seats ns ON ssh.new_seat_id = ns.id
LEFT JOIN zones nz ON ns.zone_id = nz.id
LEFT JOIN tiers nt ON ns.tier_id = nt.id;

-- Insert Seats by Zone

