# 🎫 Flowchart การจองตั๋ว AIA 88th Anniversary Concert

## 📋 Overview
ระบบจองตั๋วมี 2 ประเภทผู้ใช้งาน: **ผู้ใช้ทั่วไป (SELF)** และ **ตัวแทน (AGENT)**

---

## 🔄 Main Booking Flow

```
START
  │
  ├─► [1] เลือกประเภทผู้ใช้
  │     ├─► ผู้ใช้ทั่วไป (SELF) ──────┐
  │     └─► ตัวแทน (AGENT) ──────────┐│
  │                                   ││
  │   ┌───────────────────────────────┘│
  │   │ [2A] กรอกรหัสตัวแทน            │
  │   │      - Agent Code              │
  │   │      - Agent Name              │
  │   └───────────────────────────────┐│
  │                                   ││
  │   ┌───────────────────────────────┘│
  │   │ [3] กรอกรหัสบัตร (Access Code) │
  │   │     - รหัส 8 หลัก               │
  │   │     - สูงสุด 10 รหัส            │
  │   │     - 1 Code = 1 ที่นั่ง       │
  │   │     ↓                          │
  │   │ [3.1] ตรวจสอบ Code             │
  │   │     - ตรวจสอบความถูกต้อง       │
  │   │     - ตรวจสอบว่าถูกใช้แล้วหรือไม่│
  │   │     - กำหนด Tier               │
  │   └───────────────────────────────┘
  │                 │
  │                 ↓
  ├─► [4] เลือกที่นั่ง
  │     │ ⏱️ เริ่มนับเวลา 5 นาที
  │     │
  │     ├─► [4.1] เลือกโซน (Zone)
  │     │     - แสดงโซนตาม Tier
  │     │     - Level 1, 2, 3
  │     │
  │     ├─► [4.2] เลือกที่นั่ง (Seats)
  │     │     - แสดงที่นั่งในโซน
  │     │     - เลือกได้ตามจำนวน Code
  │     │     - ที่นั่งถูกล็อค 5 นาที
  │     │
  │     └─► [4.3] ยืนยันที่นั่ง
  │           - ต้องเลือกครบตามจำนวน Code
  │           - ล็อคที่นั่งชั่วคราว
  │
  ├─► [5] กรอกข้อมูลผู้เข้าชม
  │     │ ⏱️ เวลาคงเหลือ (ต่อจากขั้นตอน 4)
  │     │
  │     ├─► สำหรับแต่ละที่นั่ง:
  │     │     - ชื่อ (ก-ฮ, A-Z)
  │     │     - นามสกุล (ก-ฮ, A-Z)
  │     │     - อีเมล
  │     │     - เบอร์โทรศัพท์ (10 หลัก)
  │     │
  │     └─► ข้อมูลผู้ติดต่อ (สำหรับรับตั๋ว):
  │           - อีเมล
  │           - เบอร์โทรศัพท์
  │
  ├─► [6] ตรวจสอบและยืนยัน
  │     │
  │     ├─► [6.1] Validate ข้อมูล
  │     │     - ตรวจสอบความครบถ้วน
  │     │     - ตรวจสอบรูปแบบอีเมล
  │     │     - ตรวจสอบเบอร์โทร
  │     │
  │     ├─► [6.2] สร้าง Booking
  │     │     - บันทึกข้อมูลการจอง
  │     │     - บันทึกข้อมูลผู้เข้าชม
  │     │     - สร้าง QR Token (AIA-XXXXXX)
  │     │     - Mark Code as Used
  │     │     - Reserve Seats
  │     │
  │     └─► [6.3] ส่งอีเมลยืนยัน
  │           - ส่งไปที่อีเมลผู้ติดต่อ
  │           - แนบ QR Code
  │           - รายละเอียดการจอง
  │
  └─► [7] แสดงหน้ายืนยัน
        │
        ├─► แสดงข้อมูล:
        │     - Booking Number
        │     - QR Codes (แต่ละที่นั่ง)
        │     - รายละเอียดที่นั่ง
        │     - ข้อมูลผู้เข้าชม
        │
        └─► ตัวเลือก:
              - ดาวน์โหลด QR Code
              - เริ่มจองใหม่
              - ดูตั๋วของฉัน

END
```

---

## 🔀 Decision Points

### ที่ขั้นตอน [1] เลือกประเภทผู้ใช้
```
┌─────────────────────┐
│ เลือกประเภทผู้ใช้   │
└──────────┬──────────┘
           │
    ┌──────┴──────┐
    │             │
    ↓             ↓
[ผู้ใช้ทั่วไป]  [ตัวแทน]
    │             │
    │             ↓
    │      [กรอกรหัสตัวแทน]
    │             │
    └──────┬──────┘
           ↓
    [กรอกรหัสบัตร]
```

### ที่ขั้นตอน [3.1] ตรวจสอบ Code
```
┌─────────────────────┐
│ ตรวจสอบ Access Code │
└──────────┬──────────┘
           │
    ┌──────┴──────┐
    │             │
    ↓             ↓
[Valid]      [Invalid]
    │             │
    ↓             ↓
[กำหนด Tier]  [แสดง Error]
    │             │
    ↓             └──► [กลับไปกรอกใหม่]
[เลือกที่นั่ง]
```

### ที่ขั้นตอน [4.2] เลือกที่นั่ง
```
┌─────────────────────┐
│ เลือกที่นั่ง        │
└──────────┬──────────┘
           │
    ┌──────┴──────┐
    │             │
    ↓             ↓
[ว่าง]      [ไม่ว่าง/ถูกล็อค]
    │             │
    ↓             ↓
[เลือกได้]   [ไม่สามารถเลือก]
    │             │
    ↓             └──► [เลือกที่นั่งอื่น]
[ล็อคที่นั่ง 5 นาที]
```

### ที่ขั้นตอน [6.2] สร้าง Booking
```
┌─────────────────────┐
│ สร้าง Booking       │
└──────────┬──────────┘
           │
    ┌──────┴──────┐
    │             │
    ↓             ↓
[สำเร็จ]     [ล้มเหลว]
    │             │
    ↓             ↓
[ส่งอีเมล]   [แสดง Error]
    │             │
    ↓             └──► [ลองใหม่]
[หน้ายืนยัน]
```

---

## ⏱️ Timer Flow

```
[เลือกที่นั่ง] ──► เริ่มนับเวลา 5:00
                    │
                    ↓
            [กรอกข้อมูลผู้เข้าชม]
                    │
                    ├─► เวลาคงเหลือ > 0 ──► [ดำเนินการต่อ]
                    │
                    └─► เวลาหมด (0:00) ──► [ปลดล็อคที่นั่ง]
                                            │
                                            ↓
                                      [รีเซ็ตการจอง]
                                            │
                                            ↓
                                      [กลับหน้าแรก]
```

---

## 🔐 Seat Locking Flow

```
[เลือกที่นั่ง]
    │
    ↓
[ตรวจสอบสถานะที่นั่ง]
    │
    ├─► ว่าง ──────────────┐
    │                      │
    ├─► ถูกล็อคโดยคนอื่น ──┼──► [ไม่สามารถเลือก]
    │                      │
    └─► ถูกจองแล้ว ────────┘
                           │
    ┌──────────────────────┘
    │
    ↓
[ล็อคที่นั่ง 5 นาที]
    │
    ├─► ยืนยันการจอง ──► [ปลดล็อค + จองถาวร]
    │
    └─► หมดเวลา/ยกเลิก ──► [ปลดล็อค]
```

---

## 📊 Data Flow

```
┌─────────────┐
│ Access Code │
└──────┬──────┘
       │
       ↓
┌─────────────┐     ┌──────────┐
│   Booking   │────►│  Seats   │
└──────┬──────┘     └────┬─────┘
       │                 │
       ↓                 ↓
┌─────────────┐     ┌──────────┐
│Booking Seats│────►│ QR Token │
└──────┬──────┘     └──────────┘
       │
       ↓
┌─────────────┐
│  Attendee   │
│   - Name    │
│   - Email   │
│   - Phone   │
└─────────────┘
```

---

## 🎯 Key Features

### 1. Code Validation
- ✅ ตรวจสอบรูปแบบ (8 หลัก)
- ✅ ตรวจสอบความถูกต้อง
- ✅ ตรวจสอบว่าถูกใช้แล้วหรือไม่
- ✅ กำหนด Tier อัตโนมัติ
- ✅ 1 Code = 1 ที่นั่ง

### 2. Seat Selection
- ✅ แสดงที่นั่งตาม Tier
- ✅ แสดงสถานะที่นั่งแบบ Real-time
- ✅ ล็อคที่นั่งชั่วคราว 5 นาที
- ✅ ป้องกันการจองซ้ำ

### 3. Timer System
- ✅ นับถอยหลัง 5 นาที
- ✅ แสดงเวลาคงเหลือ
- ✅ เตือนเมื่อเวลาใกล้หมด (< 1 นาที)
- ✅ รีเซ็ตอัตโนมัติเมื่อหมดเวลา

### 4. Individual Attendee Info
- ✅ กรอกข้อมูลแยกแต่ละที่นั่ง
- ✅ ชื่อ, นามสกุล, อีเมล, เบอร์โทร
- ✅ Validation ข้อมูล
- ✅ บันทึกใน booking_seats table

### 5. Agent Booking
- ✅ กรอกรหัสตัวแทน
- ✅ กรอก Access Code (เหมือนผู้ใช้ทั่วไป)
- ✅ เลือกที่นั่งได้ทุก Tier
- ✅ บันทึกข้อมูล Agent

### 6. QR Code System
- ✅ สร้าง QR Token (AIA-XXXXXX)
- ✅ แต่ละที่นั่งมี QR Code เฉพาะ
- ✅ ส่งทาง Email
- ✅ ใช้สำหรับ Check-in

---

## 🚨 Error Handling

### Code Entry Errors
```
- รหัสไม่ถูกต้อง ──► แสดง Error + กลับไปกรอกใหม่
- รหัสถูกใช้แล้ว ──► แสดง Error + กลับไปกรอกใหม่
- รหัสซ้ำกัน ──────► แสดง Error + กลับไปกรอกใหม่
```

### Seat Selection Errors
```
- ที่นั่งไม่ว่าง ────► แสดง Error + เลือกที่นั่งอื่น
- ที่นั่งถูกล็อค ───► แสดง Error + เลือกที่นั่งอื่น
- เลือกไม่ครบ ──────► แสดง Error + เลือกเพิ่ม
- หมดเวลา ──────────► รีเซ็ต + กลับหน้าแรก
```

### Booking Errors
```
- ข้อมูลไม่ครบ ──────► แสดง Error + กรอกข้อมูลเพิ่ม
- Email ไม่ถูกต้อง ──► แสดง Error + แก้ไข
- เบอร์โทรไม่ถูกต้อง ► แสดง Error + แก้ไข
- บันทึกล้มเหลว ─────► แสดง Error + ลองใหม่
```

---

## 📱 User Interface States

```
1. USER_TYPE_SELECTION ──► เลือกประเภทผู้ใช้
2. AGENT_CODE_ENTRY ─────► กรอกรหัสตัวแทน (Agent เท่านั้น)
3. CODE_ENTRY ───────────► กรอกรหัสบัตร
4. SEAT_SELECTION ───────► เลือกที่นั่ง
5. DETAILS ──────────────► กรอกข้อมูลผู้เข้าชม
6. CONFIRMATION ─────────► แสดงหน้ายืนยัน
```

---

## 🔄 Navigation Flow

```
[หน้าแรก]
    │
    ├─► Back ──► ไม่สามารถกลับได้
    │
    ↓
[กรอกรหัส Agent] (Agent เท่านั้น)
    │
    ├─► Back ──► [หน้าแรก]
    │
    ↓
[กรอกรหัสบัตร]
    │
    ├─► Back ──► [กรอกรหัส Agent] (Agent)
    │            [หน้าแรก] (User)
    │
    ↓
[เลือกที่นั่ง]
    │
    ├─► Back ──► [กรอกรหัสบัตร]
    │            (ยกเลิก Timer)
    │
    ↓
[กรอกข้อมูล]
    │
    ├─► Back ──► [เลือกที่นั่ง]
    │            (ปลดล็อคที่นั่ง)
    │
    ↓
[หน้ายืนยัน]
    │
    └─► จองใหม่ ──► [หน้าแรก]
```

---

## 📧 Email Flow

```
[สร้าง Booking สำเร็จ]
    │
    ↓
[เรียก Email Function]
    │
    ├─► [ดึงข้อมูล Booking]
    │     - Booking Info
    │     - Attendee Info
    │     - QR Tokens
    │     - Seat Info
    │
    ├─► [สร้าง Email Content]
    │     - Booking Number
    │     - QR Codes (แต่ละคน)
    │     - รายละเอียดที่นั่ง
    │     - วันที่/เวลา
    │
    └─► [ส่ง Email]
          │
          ├─► สำเร็จ ──► [แสดงหน้ายืนยัน]
          │
          └─► ล้มเหลว ──► [Log Error]
                           (ไม่ยกเลิกการจอง)
```

---

## 🎫 Ticket Retrieval Flow

```
[ดูตั๋วของฉัน]
    │
    ↓
[กรอกเบอร์โทรศัพท์]
    │
    ↓
[ค้นหา Booking]
    │
    ├─► พบ ──────────┐
    │                │
    └─► ไม่พบ ───────┼──► [แสดง Error]
                     │
    ┌────────────────┘
    │
    ↓
[แสดงรายการ Booking]
    │
    ├─► เลือก Booking
    │
    ↓
[แสดงรายละเอียด]
    │
    ├─► QR Codes
    ├─► ข้อมูลที่นั่ง
    ├─► ข้อมูลผู้เข้าชม
    └─► สถานะ Check-in
```

---

## 🔒 Security & Validation

### Input Validation
```
✅ ชื่อ-นามสกุล: ก-ฮ, A-Z, spaces only
✅ อีเมล: รูปแบบ email ที่ถูกต้อง
✅ เบอร์โทร: 10 หลัก, ตัวเลขเท่านั้น
✅ Access Code: 8 หลัก, A-Z, 0-9
✅ Agent Code: ไม่ว่าง
```

### Business Rules
```
✅ 1 Code = 1 ที่นั่ง
✅ Code ต้องไม่ซ้ำกัน
✅ Code ต้องไม่ถูกใช้แล้ว
✅ ที่นั่งต้องว่าง
✅ ล็อคที่นั่ง 5 นาที
✅ ต้องกรอกข้อมูลครบทุกที่นั่ง
```

---

## 📊 Database Tables

```
bookings
├── id (PK)
├── email
├── phone
├── status
├── user_type (SELF/AGENT)
├── agent_code
├── agent_name
└── created_at

booking_seats
├── id (PK)
├── booking_id (FK)
├── seat_id (FK)
├── first_name
├── last_name
├── email ✨ NEW
├── phone ✨ NEW
├── qr_token
├── checked_in
└── created_at

booking_codes
├── id (PK)
├── booking_id (FK)
├── code_id (FK)
└── created_at

access_codes
├── id (PK)
├── code
├── tier_id (FK)
├── is_used
└── created_at

seats
├── id (PK)
├── row
├── number
├── tier_id (FK)
├── zone_id (FK)
└── is_booked

seat_locks
├── id (PK)
├── seat_id (FK)
├── session_id
├── locked_at
└── expires_at
```

---

## 🎯 Success Metrics

```
✅ Booking Created
✅ Seats Reserved
✅ QR Tokens Generated
✅ Email Sent
✅ Codes Marked as Used
✅ Attendee Info Saved
```

---

## 📝 Notes

- Timer เริ่มนับเมื่อเข้าหน้าเลือกที่นั่ง
- ที่นั่งถูกล็อคชั่วคราว 5 นาที
- หมดเวลาจะรีเซ็ตการจองอัตโนมัติ
- Agent ต้องกรอก Access Code เหมือนผู้ใช้ทั่วไป
- แต่ละที่นั่งมีข้อมูลผู้เข้าชมแยกกัน
- QR Code ถูกสร้างสำหรับแต่ละที่นั่ง
- Email ถูกส่งไปที่ผู้ติดต่อหลัก (ในอนาคตอาจส่งให้แต่ละคน)
